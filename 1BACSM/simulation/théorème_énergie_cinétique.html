<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur TEC : Export DonnÃ©es</title>
    
    <!-- BibliothÃ¨que Graphique (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #121212; color: white; }
        #canvas-container { width: 100%; height: 100vh; }
        
        /* Panneau de ContrÃ´le */
        #ui-panel {
            position: absolute; top: 0; left: 0; bottom: 0;
            width: 380px; background: rgba(15, 15, 15, 0.95);
            padding: 15px; border-right: 1px solid #444;
            overflow-y: auto; box-sizing: border-box;
            display: flex; flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        h2 { color: #4facfe; margin: 10px 0; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        .control-group { margin-bottom: 10px; background: #1e1e1e; padding: 8px; border-radius: 4px; border: 1px solid #333; }
        label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; color: #ccc; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: #4facfe; }
        .val-disp { color: #00f260; font-weight: bold; }

        /* Boutons de contrÃ´le */
        .btn-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        button {
            padding: 8px; border: none; border-radius: 4px;
            color: white; font-weight: bold; cursor: pointer; font-size: 12px;
            transition: background 0.2s;
        }
        #btn-start { background: #2196F3; }
        #btn-start:hover { background: #42A5F5; }
        
        #btn-pause { background: #FF9800; }
        #btn-pause:hover { background: #FFB74D; }
        #btn-pause:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

        #btn-reset { background: #f44336; }
        #btn-reset:hover { background: #ef5350; }

        /* Bouton TÃ©lÃ©chargement */
        #btn-download {
            width: 100%; margin-top: 5px; background: #607D8B;
        }
        #btn-download:hover { background: #78909C; }

        /* DonnÃ©es chiffrÃ©es */
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; margin-top: 10px; }
        .data-item { background: #222; padding: 5px; border-radius: 3px; border-left: 3px solid #555; }
        .data-val { display: block; font-size: 14px; font-weight: bold; margin-top: 2px; }

        /* Zone Graphique */
        #chart-container {
            margin-top: 20px;
            background: #222;
            padding: 10px;
            border-radius: 5px;
            height: 200px;
            position: relative;
        }
    </style>

    <!-- Three.js Import -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-panel">
        <h2 style="margin-top:0;">1. Configuration</h2>

        <div class="control-group">
            <label>Masse (m) <span id="val-m" class="val-disp">10 kg</span></label>
            <input type="range" id="inp-m" min="1" max="50" value="10">
        </div>

        <div class="control-group">
            <label>Vitesse Initiale (vâ‚€) <span id="val-v0" class="val-disp">0 m/s</span></label>
            <input type="range" id="inp-v0" min="0" max="20" value="0" step="0.5">
        </div>

        <div class="control-group">
            <label>Force Motrice (F) <span id="val-f" class="val-disp">40 N</span></label>
            <input type="range" id="inp-f" min="0" max="100" value="40">
            
            <label style="margin-top:5px;">Angle (Î±) <span id="val-ang" class="val-disp">0Â°</span></label>
            <input type="range" id="inp-ang" min="-60" max="60" value="0">
        </div>

        <div class="control-group">
            <label style="color:#ff6b6b;">Frottement (f) <span id="val-fr" class="val-disp" style="color:#ff6b6b;">0 N</span></label>
            <input type="range" id="inp-fr" min="0" max="50" value="0">
        </div>

        <div class="btn-container">
            <button id="btn-start">DÃ‰MARRER</button>
            <button id="btn-pause" disabled>PAUSE</button>
            <button id="btn-reset">RESET</button>
        </div>

        <h2>2. DonnÃ©es InstantanÃ©es</h2>
        <div class="data-grid">
            <div class="data-item" style="border-color: #4facfe;">
                Position (d)<span id="d-dist" class="data-val">0.00 m</span>
            </div>
            <div class="data-item" style="border-color: #4facfe;">
                Vitesse (v)<span id="d-vel" class="data-val">0.00 m/s</span>
            </div>
            <div class="data-item" style="border-color: #00f260;">
                Variation Î”Ec<span id="d-delta-ec" class="data-val">0.0 J</span>
            </div>
            <div class="data-item" style="border-color: #ff9800;">
                Somme Travaux âˆ‘W<span id="d-sum-w" class="data-val">0.0 J</span>
            </div>
        </div>

        <h2>3. Courbes (ThÃ©orÃ¨me)</h2>
        <div id="chart-container">
            <canvas id="myChart"></canvas>
        </div>
        <button id="btn-download">ðŸ“· TÃ©lÃ©charger le Graphique</button>
        
        <div style="font-size: 10px; color: #888; margin-top: 5px; text-align: center;">
            La courbe verte (Î”Ec) et orange (âˆ‘W) doivent se superposer.
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. CONFIGURATION CHART.JS ---
        
        // Plugin pour peindre le background en noir lors de l'export
        // (Sinon l'image PNG est transparente et le texte blanc est illisible sur papier blanc)
        const pluginBackground = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart, args, options) => {
                const {ctx} = chart;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = options.color || '#222'; // Couleur de fond
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Î”Ec (J)',
                        borderColor: '#00f260',
                        backgroundColor: 'rgba(0, 242, 96, 0.1)',
                        borderWidth: 3,
                        pointRadius: 0,
                        data: [],
                        tension: 0.1
                    },
                    {
                        label: 'âˆ‘W (J)',
                        borderColor: '#ff9800',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        data: [],
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { display: true, title: { display: true, text: 'Temps (s)', color: '#666' }, grid: { color: '#333' }, ticks: { color: '#888' } },
                    y: { display: true, grid: { color: '#333' }, ticks: { color: '#888' } }
                },
                plugins: {
                    legend: { labels: { color: '#fff', font: { size: 10 } } },
                    customCanvasBackgroundColor: { color: '#222222' } // Utilisation du plugin
                }
            },
            plugins: [pluginBackground] // Activation du plugin
        });

        // --- 2. LOGIQUE DE TÃ‰LÃ‰CHARGEMENT ---
        document.getElementById('btn-download').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'graphique_energie.png';
            link.href = document.getElementById('myChart').toDataURL('image/png');
            link.click();
        });

        // --- 3. CONFIGURATION THREE.JS ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x181818);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(10, 8, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // LumiÃ¨re
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(5, 10, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // Grille
        const grid = new THREE.GridHelper(300, 150, 0x444444, 0x222222);
        scene.add(grid);

        // Objet
        const cubeGroup = new THREE.Group();
        const cube = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({ color: 0x2196F3 }));
        cube.position.y = 0.75;
        cube.castShadow = true;
        cubeGroup.add(cube);
        scene.add(cubeGroup);

        // FlÃ¨ches
        const arrowF = new THREE.ArrowHelper(new THREE.Vector3(1,0,0), new THREE.Vector3(0,0.75,0), 3, 0xffffff);
        cubeGroup.add(arrowF);
        const arrowFr = new THREE.ArrowHelper(new THREE.Vector3(-1,0,0), new THREE.Vector3(0,0.4,0), 0, 0xff0000);
        cubeGroup.add(arrowFr);

        // --- 4. SIMULATION ---
        let params = { m: 10, v0: 0, F: 40, ang: 0, fr: 0 };
        let state = { running: false, paused: false, t: 0, dist: 0, vel: 0 };
        let lastTime = 0;
        let chartUpdateCounter = 0;

        const inputs = {
            m: document.getElementById('inp-m'),
            v0: document.getElementById('inp-v0'),
            f: document.getElementById('inp-f'),
            ang: document.getElementById('inp-ang'),
            fr: document.getElementById('inp-fr')
        };
        const displays = {
            m: document.getElementById('val-m'),
            v0: document.getElementById('val-v0'),
            f: document.getElementById('val-f'),
            ang: document.getElementById('val-ang'),
            fr: document.getElementById('val-fr'),
            dist: document.getElementById('d-dist'),
            vel: document.getElementById('d-vel'),
            deltaEc: document.getElementById('d-delta-ec'),
            sumW: document.getElementById('d-sum-w')
        };
        const btns = {
            start: document.getElementById('btn-start'),
            pause: document.getElementById('btn-pause'),
            reset: document.getElementById('btn-reset')
        };

        function updateInputs() {
            if(state.running) return;
            params.m = parseFloat(inputs.m.value);
            params.v0 = parseFloat(inputs.v0.value);
            params.F = parseFloat(inputs.f.value);
            params.ang = parseFloat(inputs.ang.value);
            params.fr = parseFloat(inputs.fr.value);

            displays.m.innerText = params.m + " kg";
            displays.v0.innerText = params.v0 + " m/s";
            displays.f.innerText = params.F + " N";
            displays.ang.innerText = params.ang + "Â°";
            displays.fr.innerText = params.fr + " N";

            const rad = params.ang * Math.PI / 180;
            arrowF.setDirection(new THREE.Vector3(Math.cos(rad), Math.sin(rad), 0));
            arrowF.setLength(params.F > 0 ? 1.5 + params.F/25 : 0.001);
            arrowF.setColor(0xffff00);
            arrowFr.setLength(params.fr > 0 ? 1 + params.fr/25 : 0.001);
            state.vel = params.v0;
        }

        Object.values(inputs).forEach(inp => inp.addEventListener('input', updateInputs));

        btns.start.addEventListener('click', () => {
            state.running = true; state.paused = false; state.vel = params.v0; lastTime = performance.now();
            btns.start.style.display = 'none'; btns.pause.disabled = false;
            Object.values(inputs).forEach(i => i.disabled = true);
        });

        btns.pause.addEventListener('click', () => {
            state.paused = !state.paused;
            btns.pause.textContent = state.paused ? "REPRENDRE" : "PAUSE";
            btns.pause.style.background = state.paused ? "#4CAF50" : "#FF9800";
            if(!state.paused) lastTime = performance.now();
        });

        btns.reset.addEventListener('click', () => {
            state.running = false; state.paused = false; state.t = 0; state.dist = 0; state.vel = 0;
            cubeGroup.position.x = 0; camera.position.set(10, 8, 20);
            btns.start.style.display = 'inline-block'; btns.pause.disabled = true; btns.pause.textContent = "PAUSE"; btns.pause.style.background = "#FF9800";
            Object.values(inputs).forEach(i => i.disabled = false);
            displays.dist.innerText = "0.00 m"; displays.vel.innerText = "0.00 m/s"; displays.deltaEc.innerText = "0.0 J"; displays.sumW.innerText = "0.0 J";
            
            // Reset Graph
            myChart.data.labels = []; myChart.data.datasets.forEach(ds => ds.data = []); myChart.update();
            updateInputs();
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const now = performance.now();
            let dt = (now - lastTime) / 1000;
            lastTime = now;
            if(dt > 0.1) dt = 0.1;

            if (state.running && !state.paused) {
                state.t += dt;
                const rad = params.ang * Math.PI / 180;
                let F_net = (params.F * Math.cos(rad)) - params.fr;
                
                if (state.vel <= 0.05 && F_net <= 0 && params.v0 === 0) { F_net = 0; state.vel = 0; }
                else if (state.vel <= 0 && F_net < 0) { F_net = 0; state.vel = 0; }

                state.vel += (F_net / params.m) * dt;
                if(state.vel < 0) state.vel = 0;
                state.dist += state.vel * dt;
                cubeGroup.position.x = state.dist;
                camera.position.x += (state.dist + 5 - camera.position.x) * 0.1;

                const Ec_init = 0.5 * params.m * (params.v0 * params.v0);
                const Ec_curr = 0.5 * params.m * (state.vel * state.vel);
                const Delta_Ec = Ec_curr - Ec_init;
                const Sum_W = (params.F * state.dist * Math.cos(rad)) - (params.fr * state.dist);

                displays.dist.innerText = state.dist.toFixed(2) + " m";
                displays.vel.innerText = state.vel.toFixed(2) + " m/s";
                displays.deltaEc.innerText = Delta_Ec.toFixed(1) + " J";
                displays.sumW.innerText = Sum_W.toFixed(1) + " J";

                chartUpdateCounter++;
                if(chartUpdateCounter > 5) {
                    myChart.data.labels.push(state.t.toFixed(1));
                    myChart.data.datasets[0].data.push(Delta_Ec);
                    myChart.data.datasets[1].data.push(Sum_W);
                    if(myChart.data.labels.length > 150) {
                         myChart.data.labels.shift(); myChart.data.datasets.forEach(ds => ds.data.shift());
                    }
                    myChart.update('none');
                    chartUpdateCounter = 0;
                }
            }
            renderer.render(scene, camera);
        }

        updateInputs();
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>